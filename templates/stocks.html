{% extends "base.html" %}

{% block title %}Stocks Management - Stock Price Alert{% endblock %}

{% block content %}
<div class="space-y-8">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <p class="text-sm uppercase tracking-[0.3em] text-slate-400">Portfolio coverage</p>
            <h2 class="text-3xl font-semibold text-white leading-tight">Stocks Management</h2>
        </div>
        <button onclick="openCreateModal()" class="btn-outline">
            <i class="fas fa-plus mr-2"></i> Add Stock
        </button>
    </div>

    <!-- Stocks table -->
    <div class="glass-panel floating-card">
        <div class="px-4 py-5 sm:p-6">
            <div id="stocks-container">
                <!-- Stocks will load dynamically -->
                <div class="text-center py-8 text-slate-400">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2 text-cyan-300"></i>
                    <p>Loading stocks...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Modal -->
<div id="stockModal" class="fixed inset-0 bg-black/60 hidden overflow-y-auto h-full w-full z-50 backdrop-blur" onclick="closeModal(event)">
    <div class="relative top-20 mx-auto p-6 w-96 glass-strong rounded-xl border border-white/10 shadow-2xl" onclick="event.stopPropagation()">
        <div class="mt-1">
            <h3 id="modalTitle" class="text-lg font-semibold text-white mb-4">Add New Stock</h3>
            <form id="stockForm" onsubmit="handleSubmit(event)" class="space-y-4">
                <div>
                    <label for="symbol" class="block text-sm font-medium text-slate-300 mb-2">
                        Symbol <span class="text-rose-400">*</span>
                    </label>
                    <input type="text" id="symbol" name="symbol" required
                           class="w-full px-3 py-2 rounded-md input-dark"
                           placeholder="e.g., TSLA">
                </div>

                <div>
                    <label for="company_name" class="block text-sm font-medium text-slate-300 mb-2">
                        Company Name <span class="text-rose-400">*</span>
                    </label>
                    <input type="text" id="company_name" name="company_name" required
                           class="w-full px-3 py-2 rounded-md input-dark"
                           placeholder="e.g., Tesla Inc">
                </div>

                <div>
                    <label for="threshold" class="block text-sm font-medium text-slate-300 mb-2">
                        Alert Threshold (%) <span class="text-rose-400">*</span>
                    </label>
                    <input type="number" id="threshold" name="threshold" required step="0.1" min="0.1" max="100"
                           class="w-full px-3 py-2 rounded-md input-dark"
                           placeholder="e.g., 5.0">
                    <p class="mt-1 text-sm text-slate-400">Alert when price changes by this percentage</p>
                </div>

                <div class="flex items-center">
                    <input type="checkbox" id="is_active" name="is_active" checked
                           class="rounded border-white/20 text-cyan-400 focus:ring-cyan-400 bg-slate-900">
                    <span class="ml-2 text-sm text-slate-200">Active monitoring</span>
                </div>

                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" onclick="closeModal()"
                            class="px-4 py-2 btn-ghost">
                        Cancel
                    </button>
                    <button type="submit" id="submitBtn"
                            class="px-4 py-2 btn-primary">
                        <i class="fas fa-save mr-2"></i> Save
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let editingSymbol = null;

    // Load all stocks
    async function loadStocks() {
        try {
            const data = await apiRequest('/stocks');

            if (data.stocks.length === 0) {
                document.getElementById('stocks-container').innerHTML = `
                    <div class="text-center py-10 text-slate-400">
                        <i class="fas fa-inbox text-4xl mb-2 text-white/30"></i>
                        <p>No stocks configured</p>
                        <button onclick="openCreateModal()" class="mt-4 text-cyan-300 hover:text-white">
                            <i class="fas fa-plus mr-1"></i> Add your first stock
                        </button>
                    </div>
                `;
                return;
            }

            const stocksHtml = `
                <div class="overflow-x-auto scrollbar-thin">
                    <table class="min-w-full table-dark divide-y divide-white/5">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Stock</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Threshold</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white/5">
                            ${data.stocks.map(stock => `
                                <tr class="hover:bg-white/5 fade-in">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div>
                                            <div class="font-semibold text-white">${stock.symbol}</div>
                                            <div class="text-sm text-slate-400">${stock.company_name}</div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-white">
                                        ${stock.threshold}%
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        ${stock.is_active
                                            ? '<span class="badge-success"><i class="fas fa-check-circle mr-1"></i> Active</span>'
                                            : '<span class="badge-danger"><i class="fas fa-times-circle mr-1"></i> Inactive</span>'
                                        }
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm space-x-2">
                                        <button onclick="toggleStock('${stock.symbol}', ${stock.is_active})"
                                                class="text-${stock.is_active ? 'amber' : 'emerald'}-300 hover:text-white"
                                                title="${stock.is_active ? 'Deactivate' : 'Activate'}">
                                            <i class="fas fa-${stock.is_active ? 'pause' : 'play'}-circle"></i>
                                        </button>
                                        <a href="/stocks/${stock.symbol}/prices"
                                           class="text-cyan-300 hover:text-white"
                                           title="View prices">
                                            <i class="fas fa-chart-line"></i>
                                        </a>
                                        <button onclick="openEditModal('${stock.symbol}')"
                                                class="text-sky-300 hover:text-white"
                                                title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="deleteStock('${stock.symbol}')"
                                                class="text-rose-400 hover:text-white"
                                                title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('stocks-container').innerHTML = stocksHtml;
        } catch (error) {
            document.getElementById('stocks-container').innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <p class="text-red-800 text-center">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Error loading stocks
                    </p>
                </div>
            `;
        }
    }

    // Open create modal
    function openCreateModal() {
        editingSymbol = null;
        document.getElementById('modalTitle').textContent = 'Add New Stock';
        document.getElementById('stockForm').reset();
        document.getElementById('symbol').disabled = false;
        document.getElementById('is_active').checked = true;
        document.getElementById('stockModal').classList.remove('hidden');
    }

    // Open edit modal
    async function openEditModal(symbol) {
        try {
            const stock = await apiRequest(`/stocks/${symbol}`);
            editingSymbol = symbol;

            document.getElementById('modalTitle').textContent = 'Edit Stock';
            document.getElementById('symbol').value = stock.symbol;
            document.getElementById('symbol').disabled = true;
            document.getElementById('company_name').value = stock.company_name;
            document.getElementById('threshold').value = stock.threshold;
            document.getElementById('is_active').checked = stock.is_active;

            document.getElementById('stockModal').classList.remove('hidden');
        } catch (error) {
            showToast('Error loading stock details', 'error');
        }
    }

    // Close modal
    function closeModal(event) {
        if (!event || event.target.id === 'stockModal') {
            document.getElementById('stockModal').classList.add('hidden');
            editingSymbol = null;
        }
    }

    // Handle form submit
    async function handleSubmit(event) {
        event.preventDefault();

        const formData = {
            symbol: document.getElementById('symbol').value.toUpperCase(),
            company_name: document.getElementById('company_name').value,
            threshold: parseFloat(document.getElementById('threshold').value),
            is_active: document.getElementById('is_active').checked
        };

        try {
            if (editingSymbol) {
                // Update existing stock
                await apiRequest(`/stocks/${editingSymbol}`, {
                    method: 'PUT',
                    body: JSON.stringify(formData)
                });
                showToast('Stock updated successfully', 'success');
            } else {
                // Create new stock
                await apiRequest('/stocks', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });
                showToast('Stock created successfully', 'success');
            }

            closeModal();
            loadStocks();
        } catch (error) {
            // Error already shown by apiRequest
        }
    }

    // Toggle stock active status
    async function toggleStock(symbol, currentStatus) {
        try {
            await apiRequest(`/stocks/${symbol}/toggle`, {
                method: 'PATCH'
            });
            showToast(`Stock ${currentStatus ? 'deactivated' : 'activated'} successfully`, 'success');
            loadStocks();
        } catch (error) {
            // Error already shown by apiRequest
        }
    }

    // Delete stock
    async function deleteStock(symbol) {
        if (!confirm(`Are you sure you want to delete ${symbol}? This will also delete all associated price history and alerts.`)) {
            return;
        }

        try {
            await apiRequest(`/stocks/${symbol}`, {
                method: 'DELETE'
            });
            showToast('Stock deleted successfully', 'success');
            loadStocks();
        } catch (error) {
            // Error already shown by apiRequest
        }
    }

    // Load stocks on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadStocks();
    });

    // Close modal with Escape key
    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
            closeModal();
        }
    });
</script>
{% endblock %}
